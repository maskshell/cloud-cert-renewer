name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 0.1.0). Leave empty to use version from pyproject.toml"
        required: false
        type: string
      release_type:
        description: "Release type"
        required: true
        type: choice
        options:
          - release
          - pre-release
          - test
        default: release
      publish_docker:
        description: "Publish Docker image"
        required: false
        type: boolean
        default: true
      publish_helm:
        description: "Publish Helm Chart"
        required: false
        type: boolean
        default: true
      publish_pypi:
        description: "Publish PyPI package"
        required: false
        type: boolean
        default: true
  push:
    tags:
      - "v*"

jobs:
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      is_release: ${{ steps.version.outputs.is_release }}
      is_test: ${{ steps.version.outputs.is_test }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ -n "${{ github.event.inputs.version }}" ]; then
              VERSION="${{ github.event.inputs.version }}"
            else
              VERSION=$(grep '^version =' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
            fi
            RELEASE_TYPE="${{ github.event.inputs.release_type || 'release' }}"
          else
            # Extract version from tag (e.g., v0.1.0 -> 0.1.0)
            VERSION="${GITHUB_REF#refs/tags/v}"
            RELEASE_TYPE="release"
          fi

          # Logic:
          # - is_test: Publish to TestPyPI? (true for test/dev, false for rc/release)
          # - is_prerelease: Mark as GitHub Pre-release? (true for test/dev/rc, false for release)
          # - is_release: Is it a stable release? (true ONLY for pure semantic versions)

          if [ "$RELEASE_TYPE" = "test" ] || [[ "$VERSION" =~ -(test|dev) ]]; then
            IS_TEST="true"
            IS_PRERELEASE="true"
            IS_RELEASE="false"
          elif [[ "$VERSION" =~ -rc ]]; then
            # RC versions go to Prod PyPI but are Pre-releases
            IS_TEST="false"
            IS_PRERELEASE="true"
            IS_RELEASE="false"
          else
            # Stable release
            IS_TEST="false"
            IS_PRERELEASE="false"
            if [ "$RELEASE_TYPE" = "release" ]; then
              IS_RELEASE="true"
            else
              IS_RELEASE="false"
            fi
          fi

          TAG="v${VERSION}"

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "is_release=$IS_RELEASE" >> $GITHUB_OUTPUT
          echo "is_test=$IS_TEST" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "Version: $VERSION, Tag: $TAG, Release: $IS_RELEASE, Test: $IS_TEST, Pre: $IS_PRERELEASE"

      - name: Update versions in all files
        if: github.event.inputs.version != '' || github.event_name == 'push'
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Update pyproject.toml
          sed -i "s/^version = \".*\"/version = \"$VERSION\"/" pyproject.toml

          # Update __init__.py
          sed -i "s/^__version__ = \".*\"/__version__ = \"$VERSION\"/" cloud_cert_renewer/__init__.py

          # Update Chart.yaml
          sed -i "s/^version: .*/version: $VERSION/" helm/cloud-cert-renewer/Chart.yaml
          sed -i "s/^appVersion: .*/appVersion: \"$VERSION\"/" helm/cloud-cert-renewer/Chart.yaml

          echo "Updated versions to $VERSION in all files"

      - name: Verify version consistency
        run: |
          PYPROJECT_VERSION=$(grep '^version =' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          INIT_VERSION=$(grep '^__version__ =' cloud_cert_renewer/__init__.py | sed 's/__version__ = "\(.*\)"/\1/')
          CHART_VERSION=$(grep '^version:' helm/cloud-cert-renewer/Chart.yaml | sed 's/version: //')
          CHART_APP_VERSION=$(grep '^appVersion:' helm/cloud-cert-renewer/Chart.yaml | sed 's/appVersion: "\(.*\)"/\1/')

          if [ "$PYPROJECT_VERSION" != "$INIT_VERSION" ] || \
             [ "$PYPROJECT_VERSION" != "$CHART_VERSION" ] || \
             [ "$PYPROJECT_VERSION" != "$CHART_APP_VERSION" ]; then
            echo "Error: Version mismatch!"
            echo "pyproject.toml: $PYPROJECT_VERSION"
            echo "__init__.py: $INIT_VERSION"
            echo "Chart.yaml version: $CHART_VERSION"
            echo "Chart.yaml appVersion: $CHART_APP_VERSION"
            exit 1
          fi

          echo "Version consistency check passed: $PYPROJECT_VERSION"

  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Run tests
        run: uv run pytest --cov=cloud_cert_renewer --cov-report=term-missing

      - name: Check code quality
        run: |
          uv run ruff check .
          uv run ruff format --check .

      - name: Install build tools
        run: uv pip install build twine

      - name: Build distribution packages
        run: |
          rm -rf dist/ build/ *.egg-info
          uv run python -m build
          ls -lh dist/

      - name: Verify distribution packages
        run: |
          uv run python -m twine check dist/*
          uv pip install dist/*.whl --dry-run

      - name: Upload PyPI artifacts
        uses: actions/upload-artifact@v6
        with:
          name: pypi-packages
          path: dist/*
          retention-days: 30

  build-docker:
    name: Build and Publish Docker Image
    runs-on: ubuntu-latest
    needs: [prepare, build-and-test]
    if: >-
      (github.event.inputs.publish_docker != false || github.event_name == 'push') &&
      (github.event_name == 'workflow_dispatch' || github.event_name == 'push')
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: network=host

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/${{ github.repository_owner }}/cloud-cert-renewer
            ${{ secrets.DOCKERHUB_USERNAME }}/cloud-cert-renewer
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}.{{patch}}
            type=raw,value=latest,enable=${{ needs.prepare.outputs.is_release == 'true' }}
            type=raw,value=${{ needs.prepare.outputs.version }}
          # Ensure consistent labels and metadata for digest consistency
          labels: |
            org.opencontainers.image.title=cloud-cert-renewer
            org.opencontainers.image.description=Automated HTTPS certificate renewal tool for cloud services
            org.opencontainers.image.version=${{ needs.prepare.outputs.version }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.source=${{ github.repositoryUrl }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # Enable supply chain attestations (SBOM and Provenance)
          provenance: true
          sbom: true
          # Use same cache for consistency
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Output image tags
        run: |
          echo "Docker images published with tags:"
          echo "${{ steps.meta.outputs.tags }}"
          echo ""
          echo "Published to:"
          echo "  - GitHub Container Registry: ghcr.io/${{ github.repository_owner }}/cloud-cert-renewer"
          echo "  - Docker Hub: ${{ secrets.DOCKERHUB_USERNAME }}/cloud-cert-renewer"
          echo ""
          echo "Both registries contain identical image content (same digest for each architecture)"

      - name: Update Docker Hub description from README
        uses: peter-evans/dockerhub-description@v5
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          repository: ${{ secrets.DOCKERHUB_USERNAME }}/cloud-cert-renewer
          readme-filepath: ./README.md

  build-helm:
    name: Build and Publish Helm Chart
    runs-on: ubuntu-latest
    needs: [prepare, build-and-test]
    if: >-
      (github.event.inputs.publish_helm != false || github.event_name == 'push') &&
      (github.event_name == 'workflow_dispatch' || github.event_name == 'push')
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: "latest"

      - name: Update Chart.yaml version
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          sed -i "s/^version: .*/version: $VERSION/" helm/cloud-cert-renewer/Chart.yaml
          sed -i "s/^appVersion: .*/appVersion: \"$VERSION\"/" helm/cloud-cert-renewer/Chart.yaml
          echo "Updated Chart.yaml: version=$VERSION, appVersion=$VERSION"

      - name: Package Helm Chart
        run: |
          mkdir -p .helm-release
          helm package helm/cloud-cert-renewer -d .helm-release
          ls -lh .helm-release/

      - name: Checkout gh-pages branch
        run: |
          git fetch origin gh-pages:gh-pages 2>/dev/null || echo "gh-pages branch does not exist yet"
          if git show-ref --verify --quiet refs/remotes/origin/gh-pages || \
             git show-ref --verify --quiet refs/heads/gh-pages; then
            git checkout gh-pages || git checkout -b gh-pages origin/gh-pages
            git pull origin gh-pages || true
          else
            git checkout --orphan gh-pages
            git rm -rf . 2>/dev/null || true
          fi
          mkdir -p charts

      - name: Update Helm repository index
        run: |
          REPO_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/charts"
          if [ -f index.yaml ]; then
            helm repo index .helm-release --url "$REPO_URL" --merge index.yaml
          else
            helm repo index .helm-release --url "$REPO_URL"
          fi
          mv .helm-release/index.yaml .
          mv .helm-release/*.tgz charts/ 2>/dev/null || true

      - name: Commit and push to gh-pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git
          touch .nojekyll
          git add index.yaml charts/ .nojekyll
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Add Helm chart ${{ needs.prepare.outputs.version }}"
            git push origin gh-pages
          fi

      - name: Upload Helm chart artifact
        uses: actions/upload-artifact@v6
        with:
          name: helm-chart
          path: charts/*.tgz
          retention-days: 30
        continue-on-error: true

  publish-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: [prepare, build-and-test]
    if: >-
      (github.event.inputs.publish_pypi != false || github.event_name == 'push') &&
      (github.event_name == 'workflow_dispatch' || github.event_name == 'push')
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.10"

      - name: Download PyPI artifacts
        uses: actions/download-artifact@v7
        with:
          name: pypi-packages
          path: dist/

      - name: Publish to TestPyPI
        if: needs.prepare.outputs.is_test == 'true'
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
        run: |
          echo "Publishing to TestPyPI..."
          uvx twine upload --repository testpypi dist/*
          echo "Published to TestPyPI successfully!"

      - name: Publish to PyPI
        if: needs.prepare.outputs.is_test == 'false'
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          echo "Publishing to PyPI..."
          uvx twine upload dist/*
          echo "Published to PyPI successfully!"
          echo "Package URL: https://pypi.org/project/cloud-cert-renewer/"

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [prepare, build-docker, build-helm, publish-pypi]
    if: >-
      (needs.prepare.outputs.is_release == 'true' || needs.prepare.outputs.is_prerelease == 'true') &&
      (github.event_name == 'workflow_dispatch' || github.event_name == 'push')
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download Helm chart artifact
        uses: actions/download-artifact@v7
        with:
          name: helm-chart
          path: charts/
        continue-on-error: true

      - name: Create Git tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          TAG="${{ needs.prepare.outputs.tag }}"

          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists, skipping tag creation"
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag -a "$TAG" -m "Release $TAG"
            git push origin "$TAG"
            echo "Created and pushed tag: $TAG"
          fi

      - name: Extract release notes from CHANGELOG
        id: release_notes
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          # Extract release notes from CHANGELOG.md
          # Match from "## [VERSION] - DATE" or "## [VERSION]" to next "## [" line
          # Exclude the version header line itself
          awk -v version="$VERSION" '
            BEGIN { in_section = 0 }
            /^## \[/ {
              if (in_section) { exit }
              if ($0 ~ "^## \\[" version "\\]") {
                in_section = 1
                next
              }
            }
            in_section { print }
          ' CHANGELOG.md > /tmp/release_notes.txt || true

          # Check if extraction was successful (file is not empty and has content)
          if [ ! -s /tmp/release_notes.txt ] || [ "$(wc -l < /tmp/release_notes.txt)" -eq 0 ]; then
            echo "Warning: Failed to extract release notes for version $VERSION, using fallback"
            echo "Release $VERSION" > /tmp/release_notes.txt
          fi

          # Output release notes to GitHub Actions output
          {
            echo "notes<<EOF"
            cat /tmp/release_notes.txt
            echo "EOF"
          } >> $GITHUB_OUTPUT

          # Debug: Show extracted content
          echo "Extracted release notes:"
          cat /tmp/release_notes.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          name: Release ${{ needs.prepare.outputs.tag }}
          body: |
            ${{ steps.release_notes.outputs.notes }}

            ## Artifacts

            ### Docker Image

            **GitHub Container Registry:**
            - `ghcr.io/${{ github.repository_owner }}/cloud-cert-renewer:${{ needs.prepare.outputs.version }}`
            - `ghcr.io/${{ github.repository_owner }}/cloud-cert-renewer:${{ needs.prepare.outputs.tag }}`
            - `ghcr.io/${{ github.repository_owner }}/cloud-cert-renewer:latest`

            **Docker Hub:**
            - `${{ secrets.DOCKERHUB_USERNAME }}/cloud-cert-renewer:${{ needs.prepare.outputs.version }}`
            - `${{ secrets.DOCKERHUB_USERNAME }}/cloud-cert-renewer:${{ needs.prepare.outputs.tag }}`
            - `${{ secrets.DOCKERHUB_USERNAME }}/cloud-cert-renewer:latest`

            - **Multi-architecture**: Supports amd64 and arm64 platforms
            - **Digest consistency**: Both registries contain identical image content (same digest for each architecture)

            ### Helm Chart
            - Chart version: `${{ needs.prepare.outputs.version }}`
            - Repository: `https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/`
            - Install: >-
                `helm repo add cloud-cert-renewer
                https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/ &&
                helm install cloud-cert-renewer cloud-cert-renewer/cloud-cert-renewer`

            ### PyPI Package
            - Package: `cloud-cert-renewer==${{ needs.prepare.outputs.version }}`
            - Install: `pip install cloud-cert-renewer==${{ needs.prepare.outputs.version }}`
            - URL: https://pypi.org/project/cloud-cert-renewer/
          files: charts/*.tgz
          draft: false
          prerelease: ${{ needs.prepare.outputs.is_prerelease == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
