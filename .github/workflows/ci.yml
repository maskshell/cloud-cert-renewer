name: CI

on:
  pull_request:
    branches:
      - main
      - master
  push:
    branches:
      - main
      - master

jobs:
  lint-and-format:
    name: Lint and Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Check code formatting
        run: uv run ruff format --check .

      - name: Run linter
        run: uv run ruff check .

      - name: Check YAML files
        run: uv run yamllint . --config-file .yamllint || true

  language-check:
    name: Language Policy Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Make check_language.sh executable
        run: chmod +x scripts/check_language.sh

      - name: Check for non-English content
        run: |
          # Get changed files in PR
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git fetch origin ${{ github.base_ref }}
            FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(py|md|yaml|yml)$' || true)
          else
            FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(py|md|yaml|yml)$' || true)
          fi

          if [ -z "$FILES" ]; then
            echo "No relevant files to check"
            exit 0
          fi

          # Run language check on changed files
          ERRORS=0
          for file in $FILES; do
            if [[ "$file" =~ ^(helm/|\.pytest_cache/|__pycache__/) ]]; then
              continue
            fi

            if grep -P "[\u4e00-\u9fff]" "$file" > /dev/null 2>&1; then
              if ! grep -iE "(translation|i18n|multilingual|test data|example|例外|exception)" \
                   "$file" > /dev/null 2>&1; then
                echo "Error: $file contains Chinese characters (non-English content detected)"
                echo "Please ensure all content follows the English language policy."
                echo "See CONTRIBUTING.md for details."
                ERRORS=$((ERRORS + 1))
              fi
            fi
          done

          if [ $ERRORS -gt 0 ]; then
            echo "Language policy check failed!"
            exit 1
          fi

          echo "Language policy check passed!"

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - python-version: "3.10"
          - python-version: "3.11"
          - python-version: "3.12"
          - python-version: "3.13"
          - python-version: "3.14"
            allow-prereleases: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          allow-prereleases: ${{ matrix.allow-prereleases || false }}

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Run tests
        run: uv run pytest --cov=cloud_cert_renewer --cov-report=xml --cov-report=term-missing

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: matrix.python-version == '3.10'
        with:
          file: ./coverage.xml
          fail_ci_if_error: false

  test-coverage:
    name: Test Coverage Check
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Run tests with coverage
        run: |
          uv run pytest --cov=cloud_cert_renewer --cov-report=term-missing --cov-report=html

      - name: Check coverage thresholds
        run: |
          # Install bc for floating point comparison
          sudo apt-get update && sudo apt-get install -y bc || true

          COVERAGE=$(uv run pytest --cov=cloud_cert_renewer --cov-report=term-missing -q 2>&1 | \
            grep "TOTAL" | awk '{print $NF}' | sed 's/%//')
          echo "Current coverage: ${COVERAGE}%"

          # Check if coverage meets minimum requirements
          # Design pattern layer should be 100%, overall should be 80%+
          if command -v bc &> /dev/null; then
            if (( $(echo "$COVERAGE < 80" | bc -l) )); then
              echo "Error: Test coverage ($COVERAGE%) is below minimum requirement (80%)"
              exit 1
            fi
          else
            # Fallback: simple integer comparison
            COVERAGE_INT=${COVERAGE%.*}
            if [ "$COVERAGE_INT" -lt 80 ]; then
              echo "Error: Test coverage ($COVERAGE%) is below minimum requirement (80%)"
              exit 1
            fi
          fi

          echo "Test coverage check passed: ${COVERAGE}%"

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/

  pre-commit:
    name: Pre-commit Hooks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Run pre-commit hooks (check only, no file modifications)
        env:
          # Skip hooks that modify files in CI
          # These hooks are already checked in lint-and-format job
          SKIP: trailing-whitespace,end-of-file-fixer,ruff,ruff-format,prettier
        run: uv run pre-commit run --all-files

  pre-commit-py314:
    name: Pre-commit Hooks (Python 3.14)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.14"
          allow-prereleases: true

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Run pre-commit hooks (check only, no file modifications)
        env:
          SKIP: trailing-whitespace,end-of-file-fixer,ruff,ruff-format,prettier
        run: uv run pre-commit run --all-files

  package-smoke-py314:
    name: Package Build & Install Smoke Test (Python 3.14)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.14"
          allow-prereleases: true

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Build wheel
        run: |
          uv run python -m pip install build
          rm -rf dist/ build/ *.egg-info
          uv run python -m build

      - name: Install wheel and import smoke test
        run: |
          uv run python -m pip install dist/*.whl
          uv run python -m pip check
          uv run python -c "import cloud_cert_renewer; from cloud_cert_renewer.providers.base import CloudAdapterFactory; CloudAdapterFactory.create('alibaba'); print(cloud_cert_renewer.__version__)"

      - name: Generate self-signed certificate for CLI smoke test
        run: |
          openssl req -x509 -newkey rsa:2048 -keyout /tmp/smoke-key.pem -out /tmp/smoke-cert.pem -days 1 -nodes -subj "/CN=example.com"

          {
            echo "LB_CERT<<EOF"
            cat /tmp/smoke-cert.pem
            echo "EOF"
            echo "LB_CERT_PRIVATE_KEY<<EOF"
            cat /tmp/smoke-key.pem
            echo "EOF"
          } >> $GITHUB_ENV

      - name: Run CLI smoke test (noop provider)
        env:
          SERVICE_TYPE: lb
          CLOUD_PROVIDER: noop
          AUTH_METHOD: access_key
          CLOUD_ACCESS_KEY_ID: dummy_key_id
          CLOUD_ACCESS_KEY_SECRET: dummy_key_secret
          LB_INSTANCE_ID: smoke-instance
          LB_LISTENER_PORT: "443"
          LB_REGION: cn-hangzhou
        run: uv run python -m cloud_cert_renewer

  test-design-patterns:
    name: Test Design Pattern Compliance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Check test file organization
        run: |
          echo "Checking test file organization..."

          # Check if test files follow naming conventions
          TEST_FILES=$(find tests -name "test_*.py" -type f)

          # Verify test files exist for design patterns
          MISSING_TESTS=0

          # Check for factory pattern tests
          if ! ls tests/test_*_factory.py 1> /dev/null 2>&1; then
            echo "Warning: No factory pattern test files found (test_*_factory.py)"
          fi

          # Check for strategy pattern tests
          if ! ls tests/test_*_strategy.py 1> /dev/null 2>&1; then
            echo "Warning: No strategy pattern test files found (test_*_strategy.py)"
          fi

          # Check for integration tests
          if [ ! -f "tests/test_integration.py" ]; then
            echo "Warning: Integration test file (test_integration.py) not found"
          fi

          echo "Test file organization check completed"

      - name: Run tests and verify coverage by pattern
        run: |
          echo "Running tests with coverage analysis..."
          uv run pytest --cov=cloud_cert_renewer --cov-report=term-missing -q

          echo ""
          echo "Checking design pattern layer coverage..."

          # This is a basic check - in a real scenario, you might want more sophisticated analysis
          COVERAGE_OUTPUT=$(uv run pytest --cov=cloud_cert_renewer --cov-report=term-missing -q 2>&1)

          # Check for key design pattern files
          if echo "$COVERAGE_OUTPUT" | grep -q "auth/factory.py.*100%"; then
            echo "✅ auth/factory.py: 100% coverage"
          else
            echo "⚠️  auth/factory.py: Coverage may be below 100%"
          fi

          if echo "$COVERAGE_OUTPUT" | grep -q "container.py.*100%"; then
            echo "✅ container.py: 100% coverage"
          else
            echo "⚠️  container.py: Coverage may be below 100%"
          fi
